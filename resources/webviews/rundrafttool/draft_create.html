<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKS Draft</title>
    <script type="module" src="{{toolkituri}}"></script>
    <link rel="stylesheet" href="{{cssuri}}">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"
        integrity="sha512-RNLkV3d+aLtfcpEyFG8jRbnWHxUqVZozacROI4J2F1sTaDqo1dPQYs01OMi1t1w9Y2FdbSCDSQ2ZVdAC8bzgAg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // https://code.visualstudio.com/api/extension-guides/webview#passing-messages-from-a-webview-to-an-extension
        const vscode = acquireVsCodeApi();
        const csharp = "csharp";
        const dockerfile = "dockerfile";
        const deployment = "deployment";

        function showDotnetVersion() {
            const language = $('#project-language').val()
            const fileType = $('input[name="file-type"]:checked').val()
            if (language === csharp && fileType !== 'deployment') {
                $('.csharp').show()
                $('#dotnet-version').prop('required', true);
            } else {
                $('#dotnet-version').prop('required', false);
                $('.csharp').hide()
            }
        }

        function showDockerfileFields() {
            $('#project-language').prop('required', true);
            showDotnetVersion();
            $('.dockerfile-field').show();
        }

        function showDeploymentFields() {
            $('#workflow').prop('required', true);
            $('#app-name').prop('required', true);
            $('.deployment-field').show();
        }

        function showRequiredFields() {
            const fileType = $('#file-type').val();
            const isDockerfile = fileType === dockerfile;
            const isDeployment = fileType === deployment;

            if (isDockerfile) {
                $('#workflow').prop('required', false);
                $('#app-name').prop('required', false);
                $('.deployment-field').hide();
                showDockerfileFields();
            } else if(isDeployment) {
                $('#project-language').prop('required', false);
                $('#dotnet-version').prop('required', false);
                $('.dockerfile-field').hide();
                showDeploymentFields();
            } else {
                showDockerfileFields();
                showDeploymentFields();
            }
        }

        $(document).ready(function () {
            $('.csharp').hide()
            $('#project-language').change(showDotnetVersion)
            $('#file-type').change(showRequiredFields)
            $('#submit').click(function () {
                const language = $('#project-language');
                const languageVal = language.val();
                const fileType = $('#file-type');
                const fileTypeVal = fileType.val();
                const port = $('#port');
                const portVal = port.val().trim();
                const appName = $('#app-name');
                const appNameVal = $('#app-name').val().trim();
                const workflow = $('#workflow');
                const workflowVal = workflow.val();
                const dotnetVersion = $('#dotnet-version');
                const dotnetVersionVal = dotnetVersion.val().trim();

                const missingFields = [];
                if (language.prop('required') && languageVal.length == 0) missingFields.push("language");
                if (fileType.prop('required') && fileTypeVal.length == 0) missingFields.push("file creation");
                if (port.prop('required') && portVal < 0) missingFields.push("port");
                if (appName.prop('required') && appNameVal.length == 0) missingFields.push("application name");
                if (workflow.prop('required') && workflowVal.length == 0) missingFields.push("deployment type");
                if (dotnetVersion.prop('required') && dotnetVersionVal.length == 0) missingFields.push(".NET version");

                if (missingFields.length != 0) {
                    const msg = `Fields missing: ${missingFields.join(", ")}`;
                    $('#missing').text(msg);
                    return
                }

                $('#draftform').hide();
                vscode.postMessage({
                    language: languageVal,
                    fileType: fileTypeVal,
                    port: portVal,
                    appName: appNameVal,
                    workflow: workflowVal,
                    dotnetVersion: dotnetVersionVal
                });
            })

        });

        function enforcePort(input) {
            let curr = (input.value || "0").match(/[0-9]+/)[0] || 0;
            const max = 65535;
            const min = 0;           

            if (curr > max) curr = max;
            if (curr < min) curr = min;

            input.value = curr;
        }
    </script>
</head>

<body>
    <h2>Run Draft Create</h2>

    <p>
        <code>draft create</code> adds the minimum required Dockerfile and manifest files for your Kubernetes deployment to the project directory.
        <vscode-link href="https://docs.microsoft.com/en-us/azure/aks/draft">Learn more</vscode-link>
    </p>
    
    {{#if getUserInput}}
    <form id="draftform">
        <h3>Options</h3>

        <div>
            <vscode-radio-group id="file-type" orientation="vertical">
                <label slot="label">File creation</label>
                <vscode-radio checked id="dockerfile-deployment" value="dockerfile-deployment">Dockerfile and Deployment Files</vscode-radio>
                <vscode-radio id="deployment" value="deployment">Deployment Only</vscode-radio>
                <vscode-radio id="dockerfile" value="dockerfile">Dockerfile Only</vscode-radio>
            </vscode-radio-group>
        </div>


        <div class="dockerfile-field">
            <div>
                <p for="project-language" class="label">Language</p>
                <vscode-dropdown required id="project-language">
                    <vscode-option value="clojure" selected>Clojure</vscode-option>
                    <vscode-option value="csharp">C#</vscode-option>
                    <vscode-option value="erlang">Erlang</vscode-option>
                    <vscode-option value="go">Go</vscode-option>
                    <vscode-option value="gomodule">Go (Modules)</vscode-option>
                    <vscode-option value="java">Java</vscode-option>
                    <vscode-option value="gradle">Java (Gradle)</vscode-option>
                    <vscode-option value="javascript">Javascript</vscode-option>
                    <vscode-option value="php">PHP</vscode-option>
                    <vscode-option value="python">Python</vscode-option>
                    <vscode-option value="ruby">Ruby</vscode-option>
                    <vscode-option value="rust">Rust</vscode-option>
                    <vscode-option value="swift">Swift</vscode-option>
                </vscode-dropdown>
            </div>

            <div class="csharp">
                <vscode-text-field id="dotnet-version" name="dotnet-version" placeholder="5.0">.NET version</vscode-text-field>
            </div>
        </div>

        <div>
            <vscode-text-field id="port" name="port" value="8080" type="number" onInput="enforcePort(this)" required>
                Port
            </vscode-text-field>
        </div>
            
        <div class="deployment-field">
            <div>
                <vscode-text-field id="app-name" name="app-name" placeholder="application name" required>Application name</vscode-text-field>
            </div>

            <div>
                <p class="label" for="workflow">Deployment type</p>
                <vscode-dropdown required id="workflow" name="workflow">
                    <vscode-option value="helm" selected>Helm</vscode-option>
                    <vscode-option value="kustomize">Kustomize</vscode-option>
                    <vscode-option value="manifests">Manifests</vscode-option>
                </vscode-dropdown>
            </div>
        </div>

        <div>
            <vscode-button class="button" id="submit" type="submit">Submit</vscode-button>
        </div>

        <div>
            <p id="missing" class="missing"></p>
        </div>
    </form>

    {{else}}
    <h3>Console Output</h3>
    
    {{#each resultLogs}}
    <div>{{title}}</div>
    <div>{{{breaklines messages}}}</div>
    {{/each}}

    <div>{{mainMessage}}</div>

    {{/if}}
</body>

</html>